FROM node:22-slim

ARG APT_MIRROR=mirrors.ustc.edu.cn
RUN sed -i "s|deb.debian.org|${APT_MIRROR}|g" /etc/apt/sources.list.d/debian.sources && \
    apt-get -o Acquire::https::Verify-Peer=false update && \
    apt-get -o Acquire::https::Verify-Peer=false install -y --no-install-recommends \
        ca-certificates python3 make g++ libopus-dev && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app
ARG NPM_REGISTRY=https://registry.npmjs.org/

COPY package.json package-lock.json ./
RUN --mount=type=cache,target=/root/.npm \
    sh -c 'npm config set registry "$NPM_REGISTRY"; \
    npm config set python /usr/bin/python3; \
    npm config set disturl https://npmmirror.com/mirrors/node; \
    for i in 1 2 3; do \
      npm ci --legacy-peer-deps --omit=optional --no-audit --no-fund \
        --fetch-retries=8 \
        --fetch-retry-factor=2 \
        --fetch-retry-mintimeout=20000 \
        --fetch-retry-maxtimeout=180000 \
        --fetch-timeout=300000 && exit 0; \
      if [ "$i" -lt 3 ]; then \
        echo "npm ci attempt $i failed; retrying..."; \
        sleep $((i * 15)); \
      fi; \
    done; \
    exit 1'
