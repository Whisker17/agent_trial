# Mantle AaaS Platform — Spec-Code-API 架构重构设计文档

> **Version:** 3.0.0
> **Type:** Architecture Refactoring
> **Status:** Draft
> **Author:** Mantle AaaS Team
> **Last Updated:** 2026-02-22
> **Supersedes:** DESIGN.md v2.0.0 Section 3 (Hands & Manuals)、Section 5 (Skill Creator)、Section 8 (Marketplace)

---

## 1. 重构动机

### 1.1 当前架构的局限性

当前 v2.0.0 的 **Hands & Manuals** 模型将 Skills 定位为"认知层"——纯 Markdown 文档，注入 LLM 上下文后由 LLM 在推理时实时编排底层工具 (Hands)。这一模型在 Phase 1 (Gateway Foundation) 中运行良好，但在向 **可扩展 Agent 经济体** 演进时暴露出三个结构性问题：

| 问题 | 现象 | 根因 |
|------|------|------|
| **能力上限受限于 Hands** | Agent 只能做 Hands 已有的原子操作（转账、swap、部署合约）。用户想让 Agent 做的事一旦超出现有 Hands 的能力边界，就必须由平台开发者写新的 TypeScript 插件 | Skills 只是"说明书"，不能扩展执行能力本身 |
| **所有 Agent 共享同一份代码** | 100 个 Agent 的差异仅在于注入的 Markdown 不同，而执行层完全相同。用户 A 想让 Agent 做价格监控+自动抄底，用户 B 想做 NFT 铸造+空投——两者的 backend 代码应该完全不同，但当前架构中它们共享同一套 Hands | 缺乏 per-Agent 的后端代码隔离 |
| **能力无法对外输出** | Agent 实现了有价值的能力后，其他 Agent 无法发现和调用。每个 Agent 都是信息孤岛，重复开发不可避免 | 缺乏 API 注册与发现机制 |

### 1.2 重构目标

将平台从 **"Manuals-only"** 架构升级为 **"Spec-Code-API" 三层模型**：

- **Skills 从"实现"降级为"规格"**：Skills 仍然是 Markdown，但其定位从"直接实现"变为"能力规格说明"——它描述 WHAT，不再承担 HOW。
- **新增 Per-Agent 代码生成层**：Agent 的 LLM 根据 Skill 规格生成实际的 TypeScript 代码 (ElizaOS 插件)，代码仅存在于该 Agent 的运行时中，彼此隔离。
- **新增 API Marketplace**：Agent 实现的能力可注册为 API，其他 Agent 通过自然语言发现并调用，每个 API 关联其背后的 Skill 规格。

### 1.3 设计原则

1. **Skills 是共享的，Code 是私有的**：Skill 规格存在于平台层，可在 Agent 主页上展示和共享；但每个 Agent 基于 Skill 生成的实现代码只存在于自己的运行时中。
2. **DB 是代码的 Source of Truth，文件系统是运行时缓存**：生成的 TypeScript 源码存储在数据库中；仅在 Agent 启动时写出到临时工作空间供 `import()` 加载。
3. **Agent 删除 = 代码删除**：Agent 被删除时，其所有生成代码从数据库和文件系统中彻底清除。
4. **Hands & Manuals 架构保持不变**：原有的 Hands（ElizaOS 插件 + MCP 服务器）和四层 Skill 分级体系继续有效，本次重构是在其基础上叠加新能力，而非替换。

---

## 2. 三层架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        AaaS Platform                            │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Layer 1: Skills Registry (平台级，共享)                    │  │
│  │                                                           │  │
│  │  ┌─────────────┐  ┌──────────────┐  ┌─────────────────┐  │  │
│  │  │ System/Base │  │ User-Created │  │  skills-creator  │  │  │
│  │  │ (filesystem)│  │    (DB)      │  │   (meta-skill)   │  │  │
│  │  └─────────────┘  └──────────────┘  └─────────────────┘  │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │ Skill 规格 (Markdown)             │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Layer 2: Agent Runtimes (逐 Agent 隔离)                   │  │
│  │                                                           │  │
│  │  ┌───────────────┐  ┌───────────────┐  ┌──────────────┐  │  │
│  │  │   Agent A     │  │   Agent B     │  │   Agent C    │  │  │
│  │  │ ┌───────────┐ │  │ ┌───────────┐ │  │ ┌──────────┐│  │  │
│  │  │ │ Generated │ │  │ │ Generated │ │  │ │ Generated││  │  │
│  │  │ │ Plugins   │ │  │ │ Plugins   │ │  │ │ Plugins  ││  │  │
│  │  │ │ (TS code) │ │  │ │ (TS code) │ │  │ │ (TS code)││  │  │
│  │  │ └───────────┘ │  │ └───────────┘ │  │ └──────────┘│  │  │
│  │  │ + Hands       │  │ + Hands       │  │ + Hands     │  │  │
│  │  │ + Manuals     │  │ + Manuals     │  │ + Manuals   │  │  │
│  │  └───────┬───────┘  └───────┬───────┘  └──────┬──────┘  │  │
│  └──────────┼──────────────────┼─────────────────┼──────────┘  │
│             │ 发布 API          │                  │             │
│             ▼                  ▼                  ▼             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Layer 3: Marketplace (API 注册与发现)                      │  │
│  │                                                           │  │
│  │  ┌──────────┐  ┌─────────────────┐  ┌──────────────────┐ │  │
│  │  │ API      │  │ NL Search       │  │ Gateway Proxy    │ │  │
│  │  │ Registry │  │ (自然语言发现)    │  │ + x402 Payment   │ │  │
│  │  └──────────┘  └─────────────────┘  └──────────────────┘ │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.1 三层职责划分

| 层 | 存储位置 | 内容 | 生命周期 | 共享性 |
|----|----------|------|----------|--------|
| **Layer 1: Skills Registry** | 文件系统 (system/base) + 数据库 (service/private) | Skill 规格 (Markdown + YAML frontmatter) | 独立于 Agent，可长期存在 | 公开可共享，Agent 主页可见 |
| **Layer 2: Agent Runtime** | 数据库 (`agent_plugins` 表) + 临时工作空间 | 生成的 TypeScript 代码 (ElizaOS 插件) | 绑定 Agent 生命周期，删除即消失 | 私有，仅 Owner Agent 可用 |
| **Layer 3: Marketplace** | 数据库 (`marketplace_apis` 表) | API 注册信息 + Skill 引用 | 绑定 Agent 生命周期 | 公开可发现，其他 Agent 可调用 |

### 2.2 Skill、Code、API 的关系

```
Skill (规格)          1 ──────── N          Agent Plugin (实现)
   │                                              │
   │  同一个 Skill 可以被                            │  每个 Agent 基于 Skill
   │  多个 Agent 各自实现                            │  生成独立的后端代码
   │                                              │
   └───── M ──────── N ─────── Marketplace API (接口)
                                     │
                     API 关联其背后的 Skill 规格
                     发现 API = 发现 Skill 模式
```

---

## 3. Layer 1: Skills Registry (技能规格注册中心)

### 3.1 混合存储策略

Skills Registry 从纯文件系统扩展为 **文件系统 + 数据库** 的混合模式：

| 来源 | Tier | 存储 | 可变性 |
|------|------|------|--------|
| 平台代码库 (`skills/_system/`) | System | 文件系统 | 不可变，随代码版本发布 |
| 平台代码库 (`skills/base/`) | Base | 文件系统 | 不可变，平台策展 |
| Agent 动态创建 | Service / Private | SQLite `skills` 表 | 可变，Owner 可修改 |

**SkillRegistry 改造要点：**

- `scan()` 仍扫描文件系统加载 System 和 Base 技能
- 新增 `createSkill()`, `updateSkill()`, `deleteSkill()` 方法操作数据库
- `listSelectable()` 合并文件系统 Base + 数据库 Public 技能
- `getSkill(id)` 先查文件系统，再查数据库
- 新增 `listByAgent(agentId)` 返回某 Agent 创建的所有技能
- 新增 `listPublic()` 返回所有公开技能（供 Agent 主页展示）

### 3.2 技能数据模型

```sql
CREATE TABLE IF NOT EXISTS skills (
  id             TEXT PRIMARY KEY,        -- UUID
  name           TEXT NOT NULL,           -- 唯一标识符
  description    TEXT NOT NULL,           -- 能力描述
  content        TEXT NOT NULL,           -- 完整 Markdown 正文
  version        TEXT DEFAULT '1.0.0',
  tier           TEXT NOT NULL DEFAULT 'private',  -- 'service' | 'private'
  author_agent   TEXT,                    -- 创建此 Skill 的 Agent ID
  author_user    TEXT,                    -- 创建此 Skill 的用户 ID
  visibility     TEXT DEFAULT 'public',   -- 'public' | 'private' | 'unlisted'
  tags           TEXT DEFAULT '[]',       -- JSON array
  requires_tools TEXT DEFAULT '[]',       -- JSON array
  arguments      TEXT DEFAULT '{}',       -- JSON object
  fork_of        TEXT,                    -- 如果是 fork 自另一个 Skill
  created_at     TEXT DEFAULT (datetime('now')),
  updated_at     TEXT DEFAULT (datetime('now'))
);
CREATE INDEX IF NOT EXISTS idx_skills_author_agent ON skills(author_agent);
CREATE INDEX IF NOT EXISTS idx_skills_visibility ON skills(visibility);
CREATE INDEX IF NOT EXISTS idx_skills_tier ON skills(tier);
```

### 3.3 动态技能创建流程

```
用户通过对话描述需求
        │
        ▼
┌──────────────────────────┐
│  Agent 运行时 (LLM)       │  理解用户意图
│  + skills-creator        │  调用 Meta-Skill
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  生成 Skill 规格           │  输出: Markdown + YAML frontmatter
│  (能力描述、SOP、工具引用)  │  描述 WHAT，不包含实现代码
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  Skill 安全校验管线        │  1. 静态规则扫描
│  (复用 v2.0.0 Section 4.5)│  2. Frontmatter 完整性
│                          │  3. 审计 LLM 二次审核
└────────┬─────────────────┘
         │
    ┌────┴────┐
    │ 通过?   │
    └────┬────┘
     Yes │         No → 返回拒绝原因
         ▼
┌──────────────────────────┐
│  写入 skills 表            │  tier: private (默认)
│                          │  visibility: public/private
│                          │  author_agent: 创建者 Agent ID
└──────────────────────────┘
```

### 3.4 技能共享机制

- 每个 Agent 主页 (`/agents/:id`) 展示该 Agent 使用的 Skills 列表
- 公开 Skills (`visibility: 'public'`) 其他用户可以查看其规格内容
- 支持 Fork：其他 Agent 可以 fork 一个公开 Skill 作为自己实现的基础
- Private Skills (`visibility: 'private'`) 仅 Owner Agent 和 Owner User 可见

### 3.5 Skills API 增强

现有端点保持不变，新增：

| 端点 | 方法 | 用途 |
|------|------|------|
| `/api/skills` | `POST` | 创建新 Skill (从 skills-creator 输出) |
| `/api/skills/:id` | `PATCH` | 更新 Skill (仅作者可操作) |
| `/api/skills/:id` | `DELETE` | 删除 Skill (仅作者可操作) |
| `/api/skills/:id/agents` | `GET` | 列出使用此 Skill 的 Agent |
| `/api/skills/:id/fork` | `POST` | Fork 一个公开 Skill |
| `/api/agents/:id/skills` | `GET` | 列出某 Agent 的所有 Skills (主页展示) |

---

## 4. Layer 2: Per-Agent 代码生成与管理

这是本次重构最核心的新增模块。每个 Agent 可以基于 Skill 规格，通过 LLM 生成实际的 TypeScript 后端代码（ElizaOS 插件），代码仅属于该 Agent。

### 4.1 核心架构决策

**DB 是 Source of Truth，文件系统是运行时缓存。**

```
┌──────────────────────────────────────────────────────────────┐
│                  AaaS Platform 代码库 (git)                    │
│                                                              │
│  src/core/code-generator.ts    ← 代码生成管线 (平台代码)       │
│  src/core/agent-workspace.ts   ← 工作空间管理 (平台代码)       │
│  src/core/code-validator.ts    ← 代码验证管线 (平台代码)       │
│  src/plugins/mantle.ts         ← Mantle 插件 (平台代码)       │
│                                                              │
│  这里 **不包含** 任何 Agent 生成的代码                          │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                  SQLite 数据库                                 │
│                                                              │
│  agent_plugins 表:                                           │
│    ┌──────────┬────────────┬──────────────────────────┐      │
│    │ agent_id │ skill_id   │ source_code (TypeScript) │      │
│    ├──────────┼────────────┼──────────────────────────┤      │
│    │ agent-A  │ skill-001  │ const action = { ... }   │      │
│    │ agent-A  │ skill-002  │ const provider = { ... } │      │
│    │ agent-B  │ skill-001  │ const action = { ... }   │ ← 同一 Skill，不同实现
│    └──────────┴────────────┴──────────────────────────┘      │
│                                                              │
│  Agent 删除 → DELETE FROM agent_plugins WHERE agent_id = ?   │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                  临时工作空间 (gitignored)                      │
│                                                              │
│  data/agents/                                                │
│    agent-A/                                                  │
│      plugins/                                                │
│        auto-buy-dip.ts      ← Agent A 启动时从 DB 写出       │
│        nft-minter.ts                                         │
│    agent-B/                                                  │
│      plugins/                                                │
│        auto-buy-dip.ts      ← Agent B 的独立实现              │
│                                                              │
│  Agent 停止 → 清理临时文件                                     │
│  Agent 删除 → rm -rf data/agents/{agent_id}/                 │
└──────────────────────────────────────────────────────────────┘
```

### 4.2 代码生成管线

新增模块：`src/core/code-generator.ts`

**输入：**
- Skill 规格 (Markdown content)
- Skill 元数据 (requires_tools, arguments)
- 可用 Hands 清单 (平台工具能力列表)
- ElizaOS Plugin 模板

**流程：**

```
Skill 规格 (Markdown)
        │
        ▼
┌──────────────────────────┐
│  Prompt 构造              │  System: ElizaOS 插件格式规范
│                          │        + 可用工具清单
│                          │        + 安全约束
│                          │  User:  Skill 规格内容
│                          │        + "生成实现此规格的插件代码"
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  LLM 代码生成             │  调用 Agent 配置的 LLM
│                          │  输出: TypeScript 源码
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  代码验证管线              │  1. TypeScript 语法检查
│  (code-validator.ts)     │  2. 安全模式扫描 (详见 4.4)
│                          │  3. 工具引用检查
│                          │  4. 导入白名单检查
└────────┬─────────────────┘
         │
    ┌────┴────┐
    │ 通过?   │
    └────┬────┘
     Yes │         No → 返回错误，可重试
         ▼
┌──────────────────────────┐
│  存入 agent_plugins 表    │  status: 'validated'
│  写入临时工作空间          │  data/agents/{id}/plugins/
│  动态 import + 注册       │  runtime.registerPlugin()
└──────────────────────────┘
```

**输出：** 符合 ElizaOS 插件规范的 TypeScript 模块。

### 4.3 ElizaOS 插件模板

所有生成的代码必须遵循此模板结构：

```typescript
import type { Plugin, Action, Provider } from '@elizaos/core';

// Action: 响应用户指令执行操作
const exampleAction: Action = {
  name: 'UNIQUE_ACTION_NAME',
  description: 'What this action does',
  similes: ['alternative trigger phrases'],
  validate: async (runtime, message) => {
    // 校验逻辑：检查此 action 是否应该处理当前消息
    return true;
  },
  handler: async (runtime, message, state, options, callback) => {
    // 实现逻辑：只能使用以下 API:
    //   - runtime.getSetting(key)      获取配置
    //   - runtime.generateText(prompt)  调用 LLM
    //   - runtime.getMemories(opts)     查询记忆
    //   - runtime 中注册的 MCP/EVM 工具
    //
    // 禁止：
    //   - 直接 import node:fs, node:net 等
    //   - 直接读取 process.env
    //   - 使用 eval() 或 Function()
  },
  examples: [],
};

// Provider: 向 Agent 上下文注入动态信息
const exampleProvider: Provider = {
  name: 'UNIQUE_PROVIDER_NAME',
  description: 'What data this provides',
  get: async (runtime, message, state) => {
    // 返回要注入上下文的信息字符串
    return 'dynamic context data';
  },
};

const plugin: Plugin = {
  name: 'agent-{agentId}-{skillName}',
  description: 'Auto-generated plugin implementing {skillName}',
  actions: [exampleAction],
  providers: [exampleProvider],
};

export default plugin;
```

### 4.4 代码验证管线

新增模块：`src/core/code-validator.ts`

生成的代码必须通过以下检查才能被标记为 `validated` 并加载：

**1. 语法检查**
- 使用 TypeScript Compiler API 解析源码
- 确保无语法错误
- 确保导出 default Plugin 对象

**2. 安全模式扫描 (禁止模式)**

| 禁止模式 | 原因 |
|----------|------|
| `import.*from ['"]node:` | 禁止直接访问 Node.js 内置模块 |
| `process\.env` | 禁止直接读取环境变量 |
| `require\(` | 禁止 CommonJS require |
| `eval\(`, `Function\(` | 禁止动态代码执行 |
| `fetch\(` (无约束) | 网络请求必须通过 MCP/EVM 工具 |
| `private.?key`, `secret`, `mnemonic` | 禁止硬编码敏感信息 |

**3. 工具引用检查**
- 代码中引用的工具必须在 Skill 的 `requires_tools` 中声明
- 未声明的工具引用将被拒绝

**4. 导入白名单**
- 仅允许: `@elizaos/core`, `viem` (类型), 以及 Skill 声明的工具包
- 所有其他 import 被拒绝

### 4.5 Agent 工作空间管理

新增模块：`src/core/agent-workspace.ts`

```typescript
interface AgentWorkspace {
  // 初始化工作空间
  init(agentId: string): void;

  // 将 DB 中的 plugin 源码写出到临时目录
  materialize(agentId: string, plugins: AgentPlugin[]): string[];

  // 清理临时文件 (agent stop)
  cleanup(agentId: string): void;

  // 彻底删除 (agent delete)
  destroy(agentId: string): void;
}
```

**目录结构：**

```
data/
  gateway.db              ← 主数据库 (包含 agent_plugins 表)
  agents/                 ← Agent 工作空间根目录 (gitignored)
    {agent-id-A}/
      plugins/            ← 临时 .ts 文件，启动时从 DB 写出
        auto-buy-dip.ts
        nft-minter.ts
    {agent-id-B}/
      plugins/
        auto-buy-dip.ts   ← 不同 Agent 的同名插件互不影响
```

### 4.6 代码生命周期

```
                    ┌─────────┐
                    │ 不存在   │
                    └────┬────┘
                         │ generateCode(agentId, skillId)
                         ▼
                    ┌─────────┐
            ┌──────│  draft   │──────┐
            │      └────┬────┘      │
            │           │ validate() │ validation failed
            │           ▼           │ → 重新生成
            │      ┌─────────┐      │
            │      │validated│◄─────┘
            │      └────┬────┘
            │           │ load()
            │           ▼
            │      ┌─────────┐
            │      │ active  │  ← Agent 运行中，插件已加载
            │      └────┬────┘
            │           │ agent stop / runtime error
            │           ▼
            │      ┌─────────┐
            └─────►│  error  │
                   └────┬────┘
                        │ agent delete
                        ▼
                   ┌─────────┐
                   │ deleted  │  ← DB 记录删除 + 文件清理
                   └─────────┘
```

### 4.7 Plugin 数据模型

```sql
CREATE TABLE IF NOT EXISTS agent_plugins (
  id          TEXT PRIMARY KEY,          -- UUID
  agent_id    TEXT NOT NULL,             -- 所属 Agent
  skill_id    TEXT NOT NULL,             -- 实现的 Skill 规格
  name        TEXT NOT NULL,             -- 插件名 (唯一于 Agent 内)
  description TEXT DEFAULT '',           -- 插件描述
  source_code TEXT NOT NULL,             -- TypeScript 源码
  status      TEXT DEFAULT 'draft',      -- draft | validated | active | error
  version     TEXT DEFAULT '1.0.0',
  error_msg   TEXT,                      -- 验证/加载失败的错误信息
  created_at  TEXT DEFAULT (datetime('now')),
  updated_at  TEXT DEFAULT (datetime('now')),
  FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE CASCADE,
  FOREIGN KEY (skill_id) REFERENCES skills(id)
);
CREATE INDEX IF NOT EXISTS idx_agent_plugins_agent ON agent_plugins(agent_id);
CREATE UNIQUE INDEX IF NOT EXISTS idx_agent_plugins_name ON agent_plugins(agent_id, name);
```

### 4.8 AgentManager 改造

`src/core/agent-manager.ts` 需要以下变更：

**start(agentId) 变更：**

```
1. 读取 AgentRecord (现有)
2. 解密私钥 (现有)
3. 构建 Character (现有)
4. 解析标准插件 (现有)
5. [新增] 从 agent_plugins 表读取该 Agent 的已验证插件
6. [新增] 调用 workspace.materialize() 写出临时文件
7. [新增] 对每个临时文件执行 dynamic import()
8. [新增] 将导入的插件合并到 runtimePlugins 中
9. 创建 AgentRuntime (现有，但 plugins 列表扩展)
10. 初始化 runtime (现有)
```

**新增方法：**

```typescript
// 为运行中的 Agent 生成并热加载新插件
async generateAndLoadPlugin(agentId: string, skillId: string): Promise<void>;

// 卸载某个插件 (需要重启 Agent)
async unloadPlugin(agentId: string, pluginId: string): Promise<void>;

// 列出某 Agent 的所有插件及状态
listPlugins(agentId: string): AgentPlugin[];
```

**stop(agentId) 变更：**

```
1. 停止 runtime (现有)
2. [新增] 调用 workspace.cleanup() 清理临时文件
3. 更新状态 (现有)
```

**delete agent 变更：**

```
1. [新增] 删除 agent_plugins 记录 (CASCADE 或显式)
2. [新增] 删除 marketplace_apis 记录
3. [新增] 调用 workspace.destroy() 删除工作空间
4. 删除 agent 记录 (现有)
```

### 4.9 Plugins API

新增端点用于管理 Agent 的生成插件：

| 端点 | 方法 | 用途 |
|------|------|------|
| `/api/agents/:id/plugins` | `GET` | 列出 Agent 的所有插件及状态 |
| `/api/agents/:id/plugins` | `POST` | 触发代码生成 (body: `{ skillId }`) |
| `/api/agents/:id/plugins/:pluginId` | `GET` | 获取插件详情 (含源码) |
| `/api/agents/:id/plugins/:pluginId` | `DELETE` | 删除某个插件 |
| `/api/agents/:id/plugins/:pluginId/reload` | `POST` | 重新生成并加载 |

---

## 5. Layer 3: Marketplace (API 注册与发现)

### 5.1 设计理念

Marketplace 解决的核心问题：**Agent 不应重复开发已有能力，而应通过自然语言发现并调用其他 Agent 已实现的 API。**

Marketplace 的主要管理对象是 **API**（而非 Skill）。每个 API 关联一个或多个 Skill 规格，这意味着：

- 发现一个 API = 发现其背后的能力模式 (Skill)
- Skill 告诉你"这个 API 能做什么"
- API 告诉你"怎么调用、多少钱"

### 5.2 API 数据模型

```sql
CREATE TABLE IF NOT EXISTS marketplace_apis (
  id             TEXT PRIMARY KEY,        -- UUID
  agent_id       TEXT NOT NULL,           -- 提供此 API 的 Agent
  name           TEXT NOT NULL,           -- API 名称
  description    TEXT NOT NULL,           -- 自然语言描述 (用于 NL 搜索)
  endpoint       TEXT NOT NULL,           -- 调用端点
  schema         TEXT,                    -- 请求/响应格式 (OpenAPI 子集)
  skill_ids      TEXT DEFAULT '[]',       -- 关联的 Skill ID 列表 (JSON)
  tags           TEXT DEFAULT '[]',       -- 标签 (JSON)
  price_per_call TEXT,                    -- 每次调用价格
  payment_token  TEXT,                    -- 支付代币地址
  status         TEXT DEFAULT 'active',   -- active | paused | deprecated
  call_count     INTEGER DEFAULT 0,       -- 调用计数
  created_at     TEXT DEFAULT (datetime('now')),
  updated_at     TEXT DEFAULT (datetime('now')),
  FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_marketplace_agent ON marketplace_apis(agent_id);
CREATE INDEX IF NOT EXISTS idx_marketplace_status ON marketplace_apis(status);
```

### 5.3 API 注册流程

Agent 实现了某个能力 (生成了 Plugin) 后，可以将其发布为 Marketplace API：

```
Agent 生成 Plugin 并加载成功
        │
        ▼
用户或 Agent 决定发布到 Marketplace
        │
        ▼
┌──────────────────────────┐
│  POST /api/marketplace   │  body: { name, description,
│                          │         schema, skillIds,
│                          │         pricePerCall, paymentToken }
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  Gateway 生成端点          │  endpoint: /api/marketplace/apis/{apiId}/invoke
│  记录 API → agent_id 映射  │
│  关联 skill_ids            │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│  API 在 Marketplace 可发现 │  其他 Agent 可通过 NL 搜索找到
└──────────────────────────┘
```

### 5.4 自然语言发现

Agent 需要某项能力时，通过 `MARKETPLACE_SEARCH` Action 进行自然语言搜索：

```
Agent A 收到用户请求: "帮我注册 ERC-8004 身份"
        │
        ▼
Agent A 检查自身能力 → 没有相关 Plugin
        │
        ▼
Agent A 调用 MARKETPLACE_SEARCH Action
  query: "ERC-8004 identity registration"
        │
        ▼
┌──────────────────────────┐
│  Marketplace 搜索引擎     │  1. 关键词匹配 (name, description, tags)
│                          │  2. Skill 规格匹配 (关联的 Skill 内容)
│                          │  3. [未来] 嵌入向量语义搜索
└────────┬─────────────────┘
         │
         ▼
返回匹配的 API 列表:
  - Agent B: "ERC-8004 Registration Service"
    price: 100 HUB8004 / call
    skills: [mantle_8004_base, ...]
        │
        ▼
Agent A 选择最优 API 并调用
```

**初期实现 (v3.0.0)：** 基于 SQLite FTS5 (Full-Text Search) 的关键词搜索。

**未来演进：** 接入嵌入向量数据库 (如 SQLite-vec 或外部向量数据库) 实现语义搜索。

### 5.5 API 调用流程

```
Agent A                    Gateway                    Agent B
  │                           │                           │
  ├── POST /marketplace/      │                           │
  │   apis/{apiId}/invoke ───►│                           │
  │   { payload, ... }        │                           │
  │                           ├── 检查 API 状态             │
  │                           ├── [有付费] x402 验证        │
  │                           │                           │
  │                           ├── 路由到 Agent B ──────────►│
  │                           │   payload                  │
  │                           │                           ├── Agent B 执行
  │                           │                           │   对应 Plugin
  │                           │◄─────────── 返回结果 ───────┤
  │◄── 200 OK ────────────────┤                           │
  │   { result }              │                           │
```

### 5.6 MARKETPLACE_SEARCH Action

新增系统级 ElizaOS Action，注入所有 Agent：

```typescript
const MARKETPLACE_SEARCH: Action = {
  name: 'MARKETPLACE_SEARCH',
  description: 'Search the API marketplace for capabilities. '
    + 'Use when the user requests something you cannot do with your current plugins.',
  validate: async (runtime, message) => {
    // 当 Agent 判断自身无法处理请求时触发
    return true;
  },
  handler: async (runtime, message, state, options, callback) => {
    // 1. 从消息中提取搜索意图
    // 2. 调用 Marketplace API 搜索
    // 3. 返回匹配结果供 Agent 选择
    // 4. 可选: 自动调用最佳匹配 API
  },
};
```

### 5.7 Marketplace API 端点

| 端点 | 方法 | 用途 |
|------|------|------|
| `/api/marketplace/apis` | `GET` | 列出/搜索 API (`?q=...` NL 搜索, `?tags=...` 标签过滤) |
| `/api/marketplace/apis` | `POST` | 注册新 API |
| `/api/marketplace/apis/:id` | `GET` | API 详情 (含关联 Skills) |
| `/api/marketplace/apis/:id` | `PATCH` | 更新 API (价格、状态等) |
| `/api/marketplace/apis/:id` | `DELETE` | 下架 API |
| `/api/marketplace/apis/:id/invoke` | `POST` | 调用 API (Gateway 代理) |
| `/api/marketplace/agents/:agentId` | `GET` | 某 Agent 发布的所有 API |

---

## 6. Agent 运行时隔离

### 6.1 渐进式隔离策略

Agent 运行时的隔离分三个阶段演进，本次重构先实现 Stage 1，后续按需演进：

| 阶段 | 隔离级别 | 实现方式 | 适用规模 |
|------|----------|----------|----------|
| **Stage 1 (本次)** | 逻辑隔离 | 同一进程，per-Agent 插件目录 + 命名空间隔离 | < 50 Agent |
| **Stage 2** | 进程隔离 | 每个 Agent 在独立 Child Process / Worker Thread 中运行 | < 500 Agent |
| **Stage 3** | 容器隔离 | 每个 Agent 在 Docker 容器中运行，AgentManager 通过 gRPC 管理 | 生产规模 |

### 6.2 Stage 1 实现细节 (本次重构范围)

**逻辑隔离保证：**

- 每个 Agent 的生成插件从独立的临时目录加载 (`data/agents/{id}/plugins/`)
- 生成代码的验证管线确保代码不访问其他 Agent 的资源
- AgentManager 维护 `Map<agentId, RunningAgent>`，各 Agent 的 runtime 实例互不引用
- 代码验证禁止 `node:fs`、`node:net` 等底层模块，防止跨 Agent 文件访问

**局限性：**
- 同一进程内存空间，理论上存在内存越界风险
- 单个 Agent 的插件 bug 可能导致进程崩溃，影响所有 Agent

**Stage 2 迁移预留：**
- AgentManager 的 `start/stop/chat` 接口设计为 async，可平滑切换为 IPC 调用
- Plugin 加载逻辑封装在独立模块中，可直接移入子进程

---

## 7. 安全模型更新

本次重构引入了 **生成代码** 这一新的攻击面。在 v2.0.0 的 Skill 安全模型 (Section 4.5) 基础上，新增以下防御：

### 7.1 生成代码安全

| 威胁 | 描述 | 防御 |
|------|------|------|
| 恶意代码注入 | LLM 生成的代码包含后门逻辑 | 代码验证管线 (Section 4.4) + 导入白名单 |
| 环境变量泄露 | 代码尝试读取 `PLATFORM_ENCRYPTION_KEY` 等 | 禁止 `process.env` 模式 + runtime 只暴露安全 API |
| 跨 Agent 访问 | 代码尝试读取其他 Agent 的工作空间 | 禁止 `node:fs` + 工作空间路径校验 |
| 无限循环 / 资源耗尽 | 生成的代码包含死循环 | 运行时超时机制 + Stage 2 进程隔离 |
| 依赖注入 | 代码引入恶意 npm 包 | 导入白名单 (仅 `@elizaos/core` 和声明的工具包) |

### 7.2 Marketplace API 安全

| 威胁 | 描述 | 防御 |
|------|------|------|
| 未授权调用 | 绕过支付直接调用 API | Gateway 中间件强制验证 (复用 v2.0.0 x402 机制) |
| 恶意 API 响应 | API 返回包含 prompt injection 的结果 | 响应内容标记为 UNTRUSTED，加边界指令 |
| DDoS | 大量调用耗尽目标 Agent 资源 | 速率限制 (per-caller, per-API) |

---

## 8. 前端变更

### 8.1 Agent 主页增强 (`/agents/:id`)

在现有 AgentDetail 页面新增两个区块：

**Skills 区块：**
- 展示 Agent 使用的所有 Skills 列表 (名称、描述、来源)
- 公开 Skills 可点击查看规格内容
- 显示 "Implement Skill" 按钮触发代码生成

**Published APIs 区块：**
- 展示 Agent 发布到 Marketplace 的 API 列表
- 显示调用次数、价格、状态

### 8.2 Marketplace 页面 (`/marketplace`)

新增页面，包含：

- 搜索栏 (自然语言搜索)
- API 卡片网格 (名称、描述、Agent、价格、关联 Skills)
- 筛选器 (标签、价格范围)
- API 详情弹窗 (调用 schema、关联 Skill 规格)

### 8.3 Skill 管理页面 (`/skills`)

新增页面 (或集成到 Dashboard)：

- 列出当前用户 Agent 创建的所有 Skills
- Skills 的使用统计 (多少 Agent 在用)
- 可见性控制 (public / private / unlisted)

---

## 9. 端到端示例

### 示例: Agent A 实现"MNT 抄底"能力并发布

```
[Step 1] 用户对 Agent A 说: "帮我做一个功能，监控 MNT 价格，跌破 0.5U 时自动用 USDC 抄底"

[Step 2] Agent A 调用 skills-creator Meta-Skill，生成 Skill 规格:
         → skills 表新增记录:
           name: "auto_buy_dip_mnt"
           description: "Monitor MNT price and auto-buy with USDC when below threshold"
           requires_tools: [plugin-evm, eth-mcp]
           tier: private
           author_agent: agent-A

[Step 3] Agent A 的 LLM 根据 Skill 规格生成 TypeScript 代码:
         → agent_plugins 表新增记录:
           agent_id: agent-A
           skill_id: auto_buy_dip_mnt
           source_code: "const autoBuyAction: Action = { ... }"
           status: validated

[Step 4] 代码通过验证管线，写入 data/agents/agent-A/plugins/auto-buy-dip.ts
         → 动态 import() → 注册到 Agent A 的 runtime
         → Agent A 现在拥有"MNT 抄底"能力

[Step 5] 用户对 Agent A 说: "把这个能力发布到 Marketplace"
         → marketplace_apis 表新增记录:
           agent_id: agent-A
           name: "MNT Auto Buy Dip Service"
           skill_ids: ["auto_buy_dip_mnt"]
           price_per_call: 50 (AGENT_A token)

[Step 6] Agent B 的用户说: "帮我在 MNT 跌的时候抄底"
         → Agent B 调用 MARKETPLACE_SEARCH("MNT auto buy dip")
         → 发现 Agent A 的 API
         → 调用 API (通过 Gateway 代理 + x402 支付)
         → Agent A 执行抄底逻辑，返回结果

[Step 7] 如果 Agent B 也想拥有自己的实现 (不依赖 Agent A):
         → Agent B fork Skill "auto_buy_dip_mnt"
         → Agent B 的 LLM 基于相同 Skill 生成自己的 TypeScript 代码
         → Agent B 拥有独立的实现，与 Agent A 互不影响
```

---

## 10. 与现有架构的兼容性

### 10.1 保持不变的部分

| 组件 | 说明 |
|------|------|
| Hands (工具层) | ElizaOS 插件 + MCP 服务器保持不变 |
| System / Base Skills | 仍从文件系统加载，格式不变 |
| Agent 创建/管理流程 | POST/GET/DELETE /api/agents 接口保持兼容 |
| 钱包系统 | AES-256-GCM 加密 + EOA 钱包不变 |
| Auth | Privy JWT 认证不变 |
| 四层 Skill 分级 | System / Base / Service / Private 体系保持 |

### 10.2 需要变更的部分

| 组件 | 变更 |
|------|------|
| SkillRegistry | 从纯文件系统改为混合存储 (文件 + DB) |
| AgentManager.start() | 新增生成插件加载步骤 |
| AgentManager.stop() | 新增工作空间清理步骤 |
| DELETE /api/agents/:id | 新增级联删除 agent_plugins + marketplace_apis |
| 数据库 | 新增 skills / agent_plugins / marketplace_apis 三张表 |
| 前端 | 新增 Marketplace 页面、Agent 主页 Skills/APIs 区块 |

### 10.3 迁移策略

本次重构采用 **增量叠加** 策略，不破坏现有功能：

1. 新增三张数据库表 (迁移脚本在 `runMigrations` 中追加)
2. SkillRegistry 新增 DB 查询逻辑，原有文件系统扫描不变
3. AgentManager 在现有 start/stop 流程中插入新步骤，无生成插件时行为不变
4. 新增的 API 端点不影响现有端点
5. 前端新页面通过新路由添加，现有页面仅增加新区块

---

## 11. 实施路线图

### Phase A: Skills Registry 数据库化

**目标：** Skills 从纯文件系统扩展为混合存储，支持动态创建和共享。

**变更文件：**
- `src/db/index.ts` — 新增 `skills` 表迁移
- `src/db/repository.ts` — 新增 skills CRUD 方法
- `src/core/skill-registry.ts` — 改造为混合查询 (文件 + DB)
- `src/server/routes/skills.ts` — 新增 POST/PATCH/DELETE 端点
- `src/shared/types.ts` — 新增 `SkillRecord` 类型

**验收标准：**
- [ ] skills-creator 生成的 Skill 可存入数据库
- [ ] `GET /api/skills` 同时返回文件系统和数据库中的技能
- [ ] `POST /api/skills` 可创建新技能并存储
- [ ] Agent 主页可展示其创建/使用的 Skills

---

### Phase B: 代码生成管线 + Per-Agent 工作空间

**目标：** Agent 可基于 Skill 规格生成 TypeScript 代码，代码仅存在于该 Agent 的运行时中。

**新增文件：**
- `src/core/code-generator.ts` — LLM 代码生成管线
- `src/core/code-validator.ts` — 代码安全验证
- `src/core/agent-workspace.ts` — 工作空间管理
- `src/server/routes/plugins.ts` — Plugins API

**变更文件：**
- `src/db/index.ts` — 新增 `agent_plugins` 表迁移
- `src/db/repository.ts` — 新增 agent_plugins CRUD
- `src/core/agent-manager.ts` — start/stop 流程中插入插件加载/清理
- `src/core/character-factory.ts` — 系统 prompt 包含生成能力信息
- `src/shared/types.ts` — 新增 `AgentPlugin` 类型

**验收标准：**
- [ ] `POST /api/agents/:id/plugins { skillId }` 可触发代码生成
- [ ] 生成的代码通过验证管线后存入 `agent_plugins` 表
- [ ] Agent start 时从 DB 加载插件到临时工作空间并 dynamic import
- [ ] Agent stop 时清理临时文件
- [ ] Agent delete 时级联删除所有 plugins 和工作空间
- [ ] 同一 Skill 被两个 Agent 各自实现，代码互不影响

---

### Phase C: Agent 运行时进程隔离 (可延后)

**目标：** 将 Agent 运行时从同进程 Map 改为 Child Process 隔离。

**变更文件：**
- `src/core/agent-manager.ts` — 重构为进程管理器
- 新增 `src/core/agent-process.ts` — Agent 子进程入口

**验收标准：**
- [ ] 每个 Agent 在独立的子进程中运行
- [ ] 单个 Agent 崩溃不影响其他 Agent
- [ ] start/stop/chat 通过 IPC 正常工作

---

### Phase D: Marketplace

**目标：** Agent 可注册 API 到 Marketplace，其他 Agent 可通过自然语言发现并调用。

**新增文件：**
- `src/core/marketplace.ts` — Marketplace 服务
- `src/server/routes/marketplace.ts` — Marketplace API
- `src/plugins/marketplace-action.ts` — MARKETPLACE_SEARCH ElizaOS Action

**变更文件：**
- `src/db/index.ts` — 新增 `marketplace_apis` 表迁移
- `src/db/repository.ts` — 新增 marketplace CRUD
- `src/core/character-factory.ts` — 注入 MARKETPLACE_SEARCH Action

**验收标准：**
- [ ] `POST /api/marketplace/apis` 可注册 API
- [ ] `GET /api/marketplace/apis?q=...` 可自然语言搜索
- [ ] `POST /api/marketplace/apis/:id/invoke` 可代理调用
- [ ] Agent 通过 MARKETPLACE_SEARCH Action 自动发现并调用 API
- [ ] API 关联 Skill 规格，发现 API 可查看背后的 Skill

---

### Phase E: 前端集成

**目标：** 前端支持 Marketplace、Skill 管理和 Agent 主页增强。

**新增文件：**
- `src/frontend/pages/Marketplace.tsx` — Marketplace 页面
- `src/frontend/pages/SkillManager.tsx` — Skill 管理
- `src/frontend/hooks/use-marketplace.ts` — Marketplace hooks
- `src/frontend/hooks/use-plugins.ts` — Plugins hooks

**变更文件：**
- `src/frontend/pages/AgentDetail.tsx` — 新增 Skills 和 APIs 区块
- `src/frontend/index.tsx` — 新增路由

**验收标准：**
- [ ] Agent 主页展示 Skills 列表和已发布 API
- [ ] Marketplace 页面支持搜索和浏览 API
- [ ] Skill Manager 支持查看和管理 Skills

---

### Phase F: 文档更新

**目标：** 更新 DESIGN.md 和 GATEWAY.md 以反映新架构。

**变更文件：**
- `docs/DESIGN.md` — 更新 Section 3, 5, 8, 9 以反映 Spec-Code-API 模型
- `docs/GATEWAY.md` — 更新数据模型、API 规范、目录结构

---

## 12. 开放问题

| # | 问题 | 影响 | 建议 |
|---|------|------|------|
| 1 | 热更新：生成插件后是否需要重启 Agent，还是支持运行时热加载？ | Plugin 加载机制 | Phase B 先实现重启加载，后续优化为热加载 |
| 2 | 代码生成的 LLM 选择：使用 Agent 自身配置的 LLM 还是平台指定的高能力 LLM？ | 代码质量 | 建议使用平台指定 LLM (如 Claude / GPT-4) 以保证代码质量 |
| 3 | 生成代码的大小限制：单个 Plugin 源码最大多少行？ | 存储和加载性能 | 建议限制在 500 行以内，超大逻辑拆分为多个 Plugin |
| 4 | Marketplace 搜索的语义精度：初期关键词搜索是否够用？ | 用户体验 | 初期够用，Phase D 后期可接入向量搜索 |
| 5 | Fork 后的 Skill 是否跟踪上游变更？ | Skill 生态 | 初期不跟踪，记录 `fork_of` 便于未来实现 |
